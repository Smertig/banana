name: Build On Push

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{matrix.os}}
    name: Build
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows
            os: windows-latest
            examples: >
              agent-default-blocking agent-winapi-blocking agent-any-blocking agent-beast-blocking
              agent-beast-async
              agent-default-async agent-winapi-async
              generic-api-call
            binary_path: "./$build_type/banana-example-$name.exe"

          - name: Linux
            os: ubuntu-latest
            cmake_flags: -DBANANA_EXAMPLES_ENABLE_CORO=ON -DCMAKE_CXX_COMPILER=g++-10 -DCMAKE_CXX_FLAGS=-fcoroutines
            examples: >
              agent-default-blocking agent-cpr-blocking agent-any-blocking agent-beast-blocking
              agent-beast-async
              agent-default-async agent-cpr-async
              agent-beast-coro
              custom-agent-blocking
              generic-api-call
            binary_path: "./banana-example-$name"
            packages: |
              sudo apt-get install libssl-dev g++-10 curl

          - name: macOS
            os: macos-13
            examples: >
              agent-default-blocking agent-cpr-blocking agent-any-blocking agent-beast-blocking
              agent-beast-async
              agent-default-async agent-cpr-async
              custom-agent-blocking
              generic-api-call
            binary_path: "./banana-example-$name"
            packages: |
              brew install openssl curl

          - name: Linux (bundled cpr)
            os: ubuntu-latest
            cmake_flags: -DBANANA_USE_BUNDLED_CPR=ON
            examples: >
              agent-default-blocking agent-cpr-blocking
              agent-default-async agent-cpr-async
              generic-api-call
            binary_path: "./banana-example-$name"
            packages: |
              sudo apt-get install libssl-dev

    steps:
      - uses: actions/checkout@v2

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: ${{matrix.packages}}
        if: ${{matrix.packages}}

      - name: Install vcpkg dependencies
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'examples/vcpkg.json'

      - name: Create Build Environment
        run: cmake -E make_directory ${{github.workspace}}/build

      - name: Configure CMake
        shell: bash
        run: |
          cmake -S "${{github.workspace}}/examples" -B "${{github.workspace}}/build" -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake ${{matrix.cmake_flags}}

      - name: Build and run banana examples
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: |
          build_type=Debug
          for name in $(echo "${{matrix.examples}}" | tr " " "\n")
          do
            cmake --build . --config $build_type --target banana-example-${name}
            binary_path="$(eval echo ${{matrix.binary_path}})"
            ${binary_path} "${{secrets.TG_TEST_BOT_TOKEN}}" "${{secrets.TG_TEST_USER}}" "${name}" "${{matrix.name}}"
          done
